#include <iostream>
#include <fstream>
#include <cmath>
#include <iomanip>
#include "../PYNQ_hls_settings.h"

// ¿¿¿¿ (¿¿¿¿ Matlab ¿¿)
struct SimParam {
    double R = 2.5;
    double Ld = 18e-3;
    double Lq = 32e-3;
    double lambda_m = 0.30175;
    double p = 6.0;
    double J = 0.00782;
    double B = 0.02277;
    double Ib = 10.0;
    double Vb = 178.82;
    double wb = 628.0;
};

// ¿¿¿¿¿¿¿¿ (Plant Dynamics)
void motor_plant(double state[3], DataType u_pu[2], double dt, const SimParam& p) {
    double we = state[0] * p.wb;
    double iq = state[1] * p.Ib;
    double id = state[2] * p.Ib;
    
    // ¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿¿
    double vq = (double)u_pu[0] * p.Vb;
    double vd = (double)u_pu[1] * p.Vb;

    // ¿¿¿¿¿
    double diq = (vq - p.R * iq - we * p.Ld * id - we * p.lambda_m) / p.Lq;
    double did = (vd - p.R * id + we * p.Lq * iq) / p.Ld;
    
    // ¿¿¿¿¿ (¿¿)
    double Te = 1.5 * p.p * (p.lambda_m * iq + (p.Ld - p.Lq) * id * iq);
    double dwe = (Te - p.B * (we / p.p)) * (p.p / p.J);

    // ¿¿¿¿¿¿¿¿¿¿
    state[0] += (dwe / p.wb) * dt;
    state[1] += (diq / p.Ib) * dt;
    state[2] += (did / p.Ib) * dt;
}

int main() {
    SimParam sp;
    DataType inputArr[N2] = {0};
    DataType outputArr[N2] = {0};
    
    double state[3] = {0, 0, 0}; // [omega_pu, iq_pu, id_pu]
    double t_end = 0.1;
    double dt = 1e-4;
    double ramp_time = 0.006;
    double final_rpm = 900.0;

    std::ofstream outfile("sim_results.csv");
    outfile << "Time,Ref_RPM,Act_RPM,Vq_pu,Vd_pu\n";

    std::cout << "Starting SDA HLS Testbench..." << std::endl;

    for (double t = 0; t <= t_end; t += dt) {
        // 1. ¿¿¿¿¿¿ (Ramp)
        double ref_rpm = (t < ramp_time) ? (final_rpm / ramp_time) * t : final_rpm;
        double omega_ref_pu = (ref_rpm * M_PI * sp.p / 60.0) / sp.wb;

        // 2. ¿¿ HLS ¿¿¿¿¿¿¿
        // ¿¿ PYNQ_hls.cpp ¿¿ inputArr ¿¿¿¿¿
        inputArr[0] = (DataType)0;           // T_e (¿¿¿¿¿0)
        inputArr[1] = (DataType)omega_ref_pu; // omega_hat
        inputArr[2] = (DataType)state[0];     // omega (current)
        inputArr[3] = (DataType)state[1];     // iq
        inputArr[4] = (DataType)state[2];     // id
        // inputArr[5,6] ¿ Vq, Vd ¿¿¿¿¿¿¿¿

        // 3. ¿¿ HLS ¿¿¿
        sda_main(inputArr, outputArr);

        // 4. ¿¿¿¿¿¿ (Plant)
        motor_plant(state, outputArr, dt, sp);

        // 5. ¿¿¿¿¿
        double act_rpm = state[0] * sp.wb * 60.0 / (M_PI * sp.p);
        if ((int)(t/dt) % 10 == 0) {
            outfile << t << "," << ref_rpm << "," << act_rpm << "," 
                    << (float)outputArr[0] << "," << (float)outputArr[1] << "\n";
            
            std::cout << "Time: " << std::fixed << std::setprecision(4) << t 
                      << " | Ref: " << (int)ref_rpm << " | Act: " << (int)act_rpm << std::endl;
        }
    }

    outfile.close();
    std::cout << "Simulation complete. Results saved to sim_results.csv" << std::endl;

    return 0;
}
